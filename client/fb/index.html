<!DOCTYPE html>
<html>
<head>
  <title>Facebook Login JavaScript Example</title>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="/../css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.9/semantic.min.css"/>
</head>
<body>
  <div class="ui grid center aligned">
    <div class="seven wide column">
      <div class="ui container center aligned bottom-space">
        <h1 class="ui center aligned header">Social VNX</h1>
        <button id="fb-login" class="ui facebook button">
          <i class="facebook icon"></i>
          Login
        </button>
        <button id="fb-logout" class="ui facebook button">
          <i class="facebook icon"></i>
          Logout
        </button>
        <div id="timeline"><br>
      </div>
      <div class="ui container center aligned bottom-space">
        <div class="ui fluid action input">
          <input placeholder="Apa yang sedang terjadi..." type="text" id="post">
          <button class="ui primary button" type="button" id="post-status" name="button">Post</button>
        </div>
      </div>
      <div class="ui container bottom-space">
        <div class="ui feed" id="div-content">
        </div>
      </div>
    </div>
  </div>
</body>
<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.9/semantic.min.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>
// This is called with the results from from FB.getLoginStatus().
function statusChangeCallback(response) {
  if (response.status === 'connected') {
    $( "#fb-login" ).last().addClass( "hide" );
    $( "#fb-logout" ).last().removeClass( "hide" );
    getTimeline();
  } else {
    $( "#fb-login" ).last().removeClass( "hide" );
    $( "#fb-logout" ).last().addClass( "hide" );
    // The person is not logged into your app or we are unable to tell.
    $('#div-content').html('Please log into this app.')
  }
}

function checkLoginState() {
  FB.getLoginStatus(function(response) {
    statusChangeCallback(response);
  });
}

window.fbAsyncInit = function() {
  FB.init({
    appId      : '767185866797863',
    cookie     : true,  // enable cookies to allow the server to access
    // the session
    xfbml      : true,  // parse social plugins on this page
    version    : 'v2.11' // use graph api version 2.8
  });

  FB.getLoginStatus(function(response) {
    statusChangeCallback(response);
  });

};

// Load the SDK asynchronously
(function(d, s, id) {
  $( "#fb-logout" ).last().addClass( "logout" );
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "https://connect.facebook.net/en_US/sdk.js";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));

function loginButton() {
  FB.login(function(response) {
    if (response.authResponse) {
      window.fbAsyncInit()
      localStorage.setItem("access_token", response.authResponse.accessToken);
    } else {
      console.log('User cancelled login or did not fully authorize.');
    }
  },{scope: 'email,user_likes,user_posts,publish_actions'});
}

function logoutButton() {
  FB.logout(function(response) {
    window.fbAsyncInit()
  });
}

$('#fb-login').click(function() {
  loginButton()
})

$('#fb-logout').click(function() {
  logoutButton()
})

$('#post-status').click(function() {
  axios.post('http://localhost:3000/fb/me/', {
    status: $('input#post').val()
  },{
    headers: {
      accesstoken: localStorage.getItem('access_token')
    }
  })
  .then(function (response) {
    $('input#post').val('')
    getTimeline()
  })
  .catch(function (error) {
    console.log(error);
  });
})

function getTimeline() {
  axios.get('http://localhost:3000/fb/profile/', {
    headers: {
      accesstoken: localStorage.getItem('access_token')
    }
  }).then(responseProfile => {
    console.log(responseProfile);
    axios.get('http://localhost:3000/fb/me/', {
      headers: {
        accesstoken: localStorage.getItem('access_token')
      }
    })
    .then(response => {
      $('#div-content').html(loading())
      if(response.data){
        $('#div-content').html(handleTimeline(response, responseProfile))
      }
    })
  })
  .catch(err => console.log(err))
}

function loading() {
  return `<div class="ui event">
     <div class="ui active centered inline loader">
       <div class="ui large text loader">Loading</div>
     </div>
   </div>`
}

function handleTimeline(response) {
  let timeline = ''
  response.data.data.forEach((data) => {
    var d = new Date(data.created_time);
    var n = d.toDateString();
    timeline += `
      <div class="event">
        <div class="label">
          <img src="${data.icon || '/../assets/img/post.png'}">
        </div>
        <div class="content">
          <div class="date">
            ${n}
          </div>
          <div class="summary">
            <a href="https://www.facebook.com/${data.from.id}">${data.from.name}</a> ${handleStatusType(data.status_type)}
          </div>
          <div class="extra text">
            ${data.message || data.description || ''}
            <p><i style="color:#90949c">${data.story || ''}</i></p>
          </div>
          <div class="extra images">
            <a href="${data.link}"><img src="${data.picture || ''}"></a>
          </div>
        </div>
      </div>
      <div style="margin-top:-5px;" class="ui dividing header"></div>
    `
  })
  return timeline
}

function handleStatusType(statusType) {
  switch(statusType) {
    case 'mobile_status_update':
        return 'post status';
    case 'shared_story':
        return 'shared link';
    case 'wall_post':
        return 'post on your page';
    case 'added_photos':
        return 'add new photo'
    default:
        return statusType;
  }
}
</script>

<!--
Below we include the Login Button social plugin. This button uses
the JavaScript SDK to present a graphical Login button that triggers
the FB.login() function when clicked.
-->


</html>
