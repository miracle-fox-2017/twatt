<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.9/semantic.min.css"/>
    <title></title>
  </head>
  <body>
    <div class="ui container center aligned bottom-space">
      <h1 class="ui center aligned header">Twatt</h1>
      <button class="ui primary button" type="button" id="timeline" name="button">Perbarui</button>
    </div>
    <div class="ui container center aligned bottom-space">
      <div class="ui fluid action input">
        <input placeholder="Search..." type="text" id="search">
        <button class="ui primary button" type="button" id="search-tweet" name="button">Search</button>
      </div>
    </div>
    <div class="ui container center aligned bottom-space">
      <div class="ui fluid action input">
        <input placeholder="Apa yang sedang terjadi..." type="text" id="tweet">
        <button class="ui primary button" type="button" id="post-tweet" name="button">Post</button>
      </div>
    </div>
    <div class="ui container">
      <div class="ui relaxed divided items" id="div-content">
      </div>
    </div>
  </body>
  <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.9/semantic.min.js"></script>
  <script>
  $(document).ready(function(){
    getTimeline()
  });

  $('#timeline').click(() => {
    getTimeline()
  })

  let getTimeline = () => {
    $.ajax({
      url: 'http://localhost:3000/twatt/',
      method: 'GET',
      dataType: 'JSON',
      success: function(result){
        console.log(result);
        if(result.error){
          $("#div-content").html(result.console.error());
        }else{
          $("#div-content").html(timeline(result));
        }
      },
      error: function(err){
        console.log(err);
        $("#div-content").html(err);
      }
    });
  }

  $('#post-tweet').click(() => {
    var data = {};
    data.status = $('input#tweet').val()

    $.ajax({
      url: 'http://localhost:3000/twatt/',
      type: 'POST',
      data: JSON.stringify(data),
      contentType: 'application/json',
      success: function(data) {
        console.log('success');
        console.log(JSON.stringify(data));
        getTimeline()
      }
    })
  })

  $('#search-tweet').click(() => {
    var data = $('input#search').val()

    $.ajax({
      url: `http://localhost:3000/twatt/search?q=${data}`,
      type: 'GET',
      dataType: 'JSON',
      success: function(result){
        console.log(result);
        if(result.error){
          $("#div-content").html(result.console.error());
        }else{
          if(result.statuses.length == 0){
            $("#div-content").html(`keyword '${data.search}' not found.`);
          }else{
            $("#div-content").html(timeline(result.statuses));
          }
        }
      },
      error: function(err){
        console.log('error');
        console.log(err);
        $("#div-content").html(err);
      }
    });
  })

  let timeline = (input) => {
    let dataTweet = ``
    input.forEach(tweet => {
      dataTweet += `
      <div class="item">
      <div class="ui small image">
      <img class="profile" src="${tweet.user.profile_image_url}">
      </div>
      <div class="content">
      <a class="header">${tweet.user.name}</a>
      <div class="meta">
      <a>${tweet.created_at}</a>
      </div>
      <div class="description">
      ${tweet.text}
      </div>
      </div>
      </div>
      `
    })
    return dataTweet
  }
  </script>
</html>
